\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mspposter}

% use the standard article as base class
%\LoadClass[a4paper, 11pt]{article}

\RequirePackage[utf8]{inputenc}
\RequirePackage[T1]{fontenc}
\RequirePackage{setspace}
\RequirePackage{microtype}
\RequirePackage{calc}
\RequirePackage{multicol}

\RequirePackage{ifthen}
\RequirePackage{tikz}

\usetikzlibrary{
  calc,
  backgrounds,
  shadings,
  positioning,
  decorations.fractals,
  decorations.shapes,
  decorations.text,
  decorations.pathmorphing,
  decorations.pathreplacing,
  decorations.footprints,
  decorations.markings
}

\usepgfmodule{oo}

% class for poster
\pgfooclass{poster}{

  \method poster() {
  }

  % flag indicating if cell was added to poster
  \attribute cellOpen = false;

  % standard amount of columns is 1
  \attribute columns = 1;

  \attribute currentColumn = 1;
  \attribute currentRow = 1;

  \attribute cellWidth;

  \method open_cell(){
    \pgfoothis.close_cell()
    \pgfooset{cellOpen}{true}
    %
    \ifthenelse{\equal{\pgfoovalueof{columns}}{2}}
    {
      \pgfmathparse{(1 / \pgfoovalueof{columns}) * 0.8 * \textwidth - 20} 
      \pgfoolet{cellWidth}{\pgfmathresult}
      \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{1}}
      {
        \node [
          below=of left,
          box,
          text width=\pgfoovalueof{cellWidth},
          anchor=north]
          (current)
        \bgroup 
      }
      {
        \node [
          below=of right,
          box,
          text width=\pgfoovalueof{cellWidth},
          anchor=north]
          (current)
        \bgroup 
      }
    }
    {
      \pgfmathparse{ 0.85 * \textwidth - 20} 
      \pgfoolet{cellWidth}{\pgfmathresult}
      \node [
        below=of center,
        box,
        text width=\pgfoovalueof{cellWidth},
        anchor=north]
        (current)
        \bgroup 
    }
  }

  \method close_cell(){
    \ifthenelse{\equal{\pgfoovalueof{cellOpen}}{true}}
    {
      \egroup;
      % only update center if y value is smaller
      \path let
        \p1 = (center),
        \p2 = (current.south) 
        in \ifdim \y2 < \y1 coordinate (center) at (\x1, \y2)\fi;
%      \coordinate (center) at (current.south -| center); 
      \pgfooset{cellOpen}{false}
      \ifthenelse{\equal{\pgfoovalueof{columns}}{2}}
      {
        \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{1}}
        {
          \coordinate (left) at (current.south -| left); 
          \pgfooset{currentColumn}{2}
        }
        {
          \pgfooset{currentColumn}{1}
          \coordinate (right) at (current.south -| right); 
        }
      }
      {
        \coordinate (left) at (current.south -| left); 
        \coordinate (right) at (current.south -| right); 
      }
    }
    {
    }
  }

  % set amount of columns
  \method set_columns(#1) {
    \pgfoothis.close_cell()
    \pgfooset{currentColumn}{1}
    \pgfooset{columns}{#1}
  }

}

% create tikzpicture
\AtBeginDocument {%

  \textwidth0.9\paperwidth
  \pgfoonew \poster=new poster()
  \parindent0pt
  \null
  \thispagestyle{empty}
  % offset a little bit
  \vskip2cm
  \vfill
  \hfil
  \begin{tikzpicture}[overlay,
  box/.style={
    fill=white, anchor=north,
    inner sep=10,
    draw,
    very thick,
    rounded corners}
  ]

  % initialize the anchors
  \coordinate (center) at (0, 0.5\paperheight);
  \coordinate (left) at (-.2\paperwidth,0.5\paperheight);
  \coordinate (bgleft) at (-.5\paperwidth,0);
  \coordinate (bgright) at (0.5\paperwidth,0);
  \coordinate (right) at (.2\paperwidth,0.5\paperheight);
  \coordinate (startpos) at (0,.5\paperheight);

  \coordinate (bottom) at (0,-.6\paperheight);
  \coordinate (upper) at (0,.57\paperheight);
  \shade [bottom color=red!30,top color=orange!40]
  (upper -|  bgleft) rectangle (bottom -| bgright);
}

\AtEndDocument {%
  % close open section
%  \ifthenelse{\boolean{sectionopen}}{\egroup;}{}
\poster.close_cell()

\end{tikzpicture}
\vfill
\vbox{}
\clearpage
} 

% wrapper commands to the poster class
\renewcommand\twocolumn{%
  \poster.set_columns(2)
}

\renewcommand\onecolumn{%
  \poster.set_columns(1)
}

\renewenvironment{multicols}[1]{
  \poster.set_columns(#1)
}{
  \poster.set_columns(1)
}


\renewcommand\section[1]{%

  \poster.open_cell()

%  \ifthenelse{\boolean{sectionopen}}
%    {
%      % close previous section if it was open
%      \egroup;
%
%      \node [
%        below=of \theOldRow.south,
%        box,
%   %     minimum width=\getWidth{\thePosterRow}
%        text width=0.5\textwidth % \getWidth{\thePosterRow}
%        ] (\thePosterRow)
%      \bgroup
%    }
%    {
%      \node at (startpos) [
%        box,
%        text width=\textwidth %\getWidth{\thePosterRow}
%        ] (\thePosterRow) \bgroup
%    }
%
    % center title
    % move a little to the top
    \vspace{-1em}
    \begin{center}
    \Large\bfseries #1
    \end{center}
%
%    % set flag that section is open
%    \setboolean{sectionopen}{true}
%
%    % remaining section is placed inside the node
}

