%% mspposter.sty
%% Copyright 2015 Alexander Hewer
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Alexander Hewer, email: hewer@coli.uni-saarland.de
%
% This work consists of the file mspposter.sty

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{mspposter}

\RequirePackage{ifthen}
\RequirePackage{tikz}

\usetikzlibrary{
  calc,
  backgrounds,
  positioning,
  decorations.pathmorphing
}

\usepgfmodule{oo}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% workaround for undefined control sequence error when 
% using tikzpicture inside a node
\newdimen\currentWidth
\newdimen\currentPadding

% class for poster
\pgfooclass{poster}{

  \method poster() {
    \pgfooset{columnAmount}{1}
    \pgfooset{currentColumn}{1}
  }

  % ATTRIBUTES

  \attribute blockSpacing = 20;
  \attribute blockOpen = false;
  \attribute columnAmount = 1;
  \attribute currentColumn = 1;
  \attribute blockWidth = \textwidth;
  \attribute oneColumnWidth = \textwidth; 
  \attribute twoColumnWidth = \textwidth; 
  \attribute threeColumnWidth = \textwidth; 
  \attribute blockPadding = 10;

  % METHODS

  \method openBlockOneColumn(#1){
    \currentWidth = \pgfoovalueof{oneColumnWidth} pt
    \currentPadding = \pgfoovalueof{blockPadding} pt
    \node [
      below=\pgfoovalueof{blockSpacing}pt of center,
      #1,
      text width=\currentWidth,
      inner sep=\currentPadding,
      anchor=north]
      (current)
      \bgroup 
  }

  \method openBlockTwoColumn(#1){
    \currentWidth = \pgfoovalueof{twoColumnWidth} pt
    \currentPadding = \pgfoovalueof{blockPadding} pt
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{1}}
    {
      \node [
        below=\pgfoovalueof{blockSpacing}pt of left,
        #1,
        text width=\currentWidth,
        inner sep=\currentPadding,
        anchor=north]
        (current)
      \bgroup 
    }
    {
      \node [
        below=\pgfoovalueof{blockSpacing}pt of right,
        #1,
        text width=\currentWidth,
        inner sep=\currentPadding,
        anchor=north]
        (current)
      \bgroup 
    }
  }

  \method openBlockThreeColumn(#1){
    \currentWidth = \pgfoovalueof{threeColumnWidth} pt
    \currentPadding = \pgfoovalueof{blockPadding} pt
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{1}}
    {
      \node [
        below=\pgfoovalueof{blockSpacing}pt of c3left,
        #1,
        text width=\currentWidth,
        inner sep=\currentPadding,
        anchor=north]
        (current)
      \bgroup 
    }
    {
      % else
    }
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{2}}
    {
      \node [
        below=\pgfoovalueof{blockSpacing}pt of c3center,
        #1,
        text width=\currentWidth,
        inner sep=\currentPadding,
        anchor=north]
        (current)
      \bgroup 
    }
    {
      % else
    }
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{3}}
    {
      \node [
        below=\pgfoovalueof{blockSpacing}pt of c3right,
        #1,
        text width=\currentWidth,
        inner sep=\currentPadding,
        anchor=north]
        (current)
      \bgroup 
    }
    {
      % else
    }
  }

  \method openBlock(#1){
    % try to close any open block
    \pgfoothis.closeBlock()
    % set flag to true
    \pgfooset{blockOpen}{true}
    % 
    \ifthenelse{\equal{\pgfoovalueof{columnAmount}}{1}}
    {
      \pgfoothis.openBlockOneColumn(#1)
    }
    {
      % else
    }
    \ifthenelse{\equal{\pgfoovalueof{columnAmount}}{2}}
    {
      \pgfoothis.openBlockTwoColumn(#1)
    }
    {
      % else
    }
    \ifthenelse{\equal{\pgfoovalueof{columnAmount}}{3}}
    {
      \pgfoothis.openBlockThreeColumn(#1)
    }
    {
      % else
    }
  }

  \method updateStateOneColumn(){
    % we only have one column, update all remaining anchors
    \coordinate (left) at (current.south -| left); 
    \coordinate (right) at (current.south -| right); 
    \coordinate (c3center) at (current.south -| c3center); 
    \coordinate (c3left) at (current.south -| c3left); 
    \coordinate (c3right) at (current.south -| c3right); 
  }

  \method updateStateTwoColumn(){
    % we have two columns, check which is the current one
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{1}}
    {
      % update left anchor and move to next column
      \coordinate (left) at (current.south -| left); 
      \pgfooset{currentColumn}{2}
    }
    {
      % update right anchor and move to first column
      \pgfooset{currentColumn}{1}
      \coordinate (right) at (current.south -| right); 
    }
    % update anchors for three column layout
    \path let
      \p1 = (c3left),
      \p2 = (center) 
      in coordinate (c3left) at (\x1, \y2);
    \path let
      \p1 = (c3center),
      \p2 = (center) 
      in coordinate (c3center) at (\x1, \y2);
    \path let
      \p1 = (c3right),
      \p2 = (center) 
      in coordinate (c3right) at (\x1, \y2);
  }

  \method updateStateThreeColumn(){
    % we have three columns, check which is the current one
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{1}}
    {
      % update left anchor and move to next column
      \coordinate (c3left) at (current.south -| c3left); 
      \pgfooset{currentColumn}{2}
    }
    {
    % else
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{2}}
    {
       % update center anchor and move to next column
      \coordinate (c3center) at (current.south -| c3center); 
      \pgfooset{currentColumn}{3}
    }
    {
      % else
    \ifthenelse{\equal{\pgfoovalueof{currentColumn}}{3}}
    {
      % update right anchor and move to first column
      \coordinate (c3right) at (current.south -| c3right); 
      \pgfooset{currentColumn}{1}
    }
    {
      % else
    }}}
    % update anchors for two column layout
    \path let
      \p1 = (left),
      \p2 = (center) 
      in coordinate (left) at (\x1, \y2);
    \path let
      \p1 = (right),
      \p2 = (center) 
      in coordinate (right) at (\x1, \y2);
  }

  \method closeBlock(){
    % only close block if it is open
    \ifthenelse{\equal{\pgfoovalueof{blockOpen}}{true}}
    {
      \egroup;
      % use path intersections to update coordinates
      % only update center if y value is smaller
      \path let
        \p1 = (center),
        \p2 = (current.south) 
        in \ifdim \y2 < \y1 coordinate (center) at (\x1, \y2)\fi;
      % set flag to false
      \pgfooset{blockOpen}{false}
      % update anchors and select next column
      \ifthenelse{\equal{\pgfoovalueof{columnAmount}}{1}}{
        \pgfoothis.updateStateOneColumn()
      }
      {
        % else
      }
      \ifthenelse{\equal{\pgfoovalueof{columnAmount}}{2}}
      {
        \pgfoothis.updateStateTwoColumn()
      }
      {
        % else
      }
      \ifthenelse{\equal{\pgfoovalueof{columnAmount}}{3}}
      {
        \pgfoothis.updateStateThreeColumn()
      }
      {
        % else
      }
    }
    {
      % else
    }
  }

  \method updateLayout() {
    \pgfoothis.setupAnchors()
    % set width of block in one column layout
    \pgfmathparse{ \textwidth - 2 * \pgfoovalueof{blockPadding}} 
    \pgfoolet{oneColumnWidth}{\pgfmathresult}
    % set width of block in two column layout
    \pgfmathparse{0.5 * \textwidth - 2 * \pgfoovalueof{blockPadding} - 0.5 * \pgfoovalueof{blockSpacing}} 
    \pgfoolet{twoColumnWidth}{\pgfmathresult}
    % set width of block in three column layout
    \pgfmathparse{( \textwidth - 6 * \pgfoovalueof{blockPadding} - 2 * \pgfoovalueof{blockSpacing}) / 3} 
    \pgfoolet{threeColumnWidth}{\pgfmathresult}
  }

  \method setBlockPadding(#1) {
    \pgfooset{blockPadding}{#1}
    \pgfoothis.updateLayout()
  }

  \method setBlockSpacing(#1) {
    \pgfooset{blockSpacing}{#1}
    \pgfoothis.updateLayout()
    }

  % set amount of columns
  \method setColumns(#1) {
    % try to close any open block
    \pgfoothis.closeBlock()
    % set column amount 
    \pgfooset{columnAmount}{#1}
    % return to first column after change
    \pgfooset{currentColumn}{1}
  }

  \method setupAnchors() {
    % initialize the anchors
    \coordinate (center) at (0, .54\paperheight);
    % align both anchors to create the wanted spacing between
    % two columns
    \coordinate (left) at  (-.25\textwidth - \pgfoovalueof{blockSpacing} / 4 pt, .54\paperheight);
    \coordinate (right) at ( .25\textwidth + \pgfoovalueof{blockSpacing} / 4 pt, .54\paperheight);
    % anchors for three column layout
    \coordinate (c3center) at (0, .54\paperheight);
    \coordinate (c3left) at
      ( - 2 * \pgfoovalueof{blockPadding} 
        - \pgfoovalueof{threeColumnWidth} 
        - \pgfoovalueof{blockSpacing}
        - 7pt, .54\paperheight);
    \coordinate (c3right) at  (
          2 * \pgfoovalueof{blockPadding}
        + \pgfoovalueof{threeColumnWidth}
        + \pgfoovalueof{blockSpacing}
        + 7pt, .54\paperheight);
  }
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% create tikzpicture
\AtBeginDocument {%

  % set width
  \textwidth0.9\paperwidth

  % create poster object
  \pgfoonew \poster=new poster()

  \parindent0pt
  \null
  \thispagestyle{empty}
  % offset a little bit
  \vskip2cm
  \vfill
  \hfil
  \begin{tikzpicture}[overlay,
    % style for boxes
    box/.style={
      opacity=0.5,
      text opacity=1.0,
      fill=white, anchor=north,
      draw,
      ultra thick,
      rounded corners},
      logoboxbg/.style={
        minimum width=\paperwidth + 10pt,
        text width=\textwidth,
        fill=white,
        draw=black,
        ultra thick,
        decoration=random steps,
        decorate,
        anchor=south,
        inner sep=10
      }
  ]

  \poster.updateLayout()

  % for background shading
  \coordinate (bgleft) at (-.5\paperwidth,0);
  \coordinate (bgright) at (0.5\paperwidth,0);
  \coordinate (bottom) at (0,-.6\paperheight);
  \coordinate (upper) at (0,.57\paperheight);

  % background 
  \begin{scope}[on background layer]
    \shade [bottom color=red!30,top color=orange!40]
    (upper -|  bgleft) rectangle (bottom -| bgright);
  \end{scope}
}

\AtEndDocument {%
  \poster.closeBlock()

  \end{tikzpicture}
  \vfill
  \vbox{}
  \clearpage
} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\setblockpadding}[1] {
  \poster.setBlockPadding(#1)
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\setblockspacing}[1] {
  \poster.setBlockSpacing(#1)
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\shadebackground}[2] {
\begin{scope}[on background layer]
  \shade [bottom color=#1,top color=#2]
  (upper -|  bgleft) rectangle (bottom -| bgright);
\end{scope}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{onecolumnlayout}{
  \poster.setColumns(1)
}{
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{twocolumnlayout}{
  \poster.setColumns(2)
}{
  \poster.setColumns(1)
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{threecolumnlayout}{
  \poster.setColumns(3)
}{
  \poster.setColumns(1)
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{posterblock}[1][box]{
  \poster.openBlock(#1)
}
{
  \poster.closeBlock()
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newenvironment{logobox}[1][logoboxbg]{
  \begin{scope}[on background layer]
    \coordinate (logobox) at (0, -0.5\paperheight);
    \node [above=of logobox, #1] \bgroup
}
{
  \egroup;
  \end{scope}
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
